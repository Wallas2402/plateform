<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    body {
      background: #111827;
      color: white;
    }
    table {
      width: 100%;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    .status-select {
      background: #1f2937;
      color: white;
      border-radius: 5px;
      padding: 4px;
    }
  </style>
</head>
<body class="p-6 space-y-6">

  <h1 class="text-2xl font-bold mb-4">Order Admin Dashboard</h1>

  <!-- CSV Import -->
  <div class="bg-gray-800 p-4 rounded">
    <label class="block mb-2">Import CSV File (from Formspree):</label>
    <input type="file" accept=".csv" onchange="loadCSV(event)" class="bg-gray-900 text-white p-2 rounded w-full">
  </div>

  <!-- Orders Table -->
  <div class="overflow-auto bg-gray-900 p-4 rounded shadow">
    <table id="ordersTable" class="table-auto text-sm text-white">
      <thead>
        <tr class="bg-gray-700">
          <th>Name</th>
          <th>Surname</th>
          <th>Phone</th>
          <th>Wilaya</th>
          <th>Address</th>
          <th>Quantity</th>
          <th>Product</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Export Button -->
  <button onclick="exportCSV()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded">
    Export to CSV
  </button>

  <script>
    let ordersData = [];

    function loadCSV(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const lines = e.target.result.split('\n').filter(Boolean);
        const headers = lines[0].split(',');

        const requiredFields = ['first_name', 'last_name', 'phone', 'wilaya', 'address', 'quantity', 'product'];
        if (!requiredFields.every(f => headers.includes(f))) {
          alert("CSV is missing required fields.");
          return;
        }

        const tbody = document.querySelector('#ordersTable tbody');
        tbody.innerHTML = '';
        ordersData = [];

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',');
          const rowData = {};
          headers.forEach((h, j) => {
            rowData[h.trim()] = values[j]?.trim() || '';
          });
          rowData.status = 'Pending';
          ordersData.push(rowData);

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${rowData.first_name}</td>
            <td>${rowData.last_name}</td>
            <td>${rowData.phone}</td>
            <td>${rowData.wilaya}</td>
            <td>${rowData.address}</td>
            <td>${rowData.quantity}</td>
            <td>${rowData.product}</td>
            <td>
              <select class="status-select" onchange="updateStatus(${i - 1}, this.value)">
                <option>Pending</option>
                <option>Confirmed</option>
                <option>Canceled</option>
              </select>
            </td>
          `;
          tbody.appendChild(tr);
        }
      };
      reader.readAsText(file);
    }

    function updateStatus(index, value) {
      ordersData[index].status = value;
    }

    function exportCSV() {
      if (ordersData.length === 0) {
        alert("No data to export.");
        return;
      }

      const headers = ['first_name','last_name','phone','wilaya','address','quantity','product','status'];
      const csv = [
        headers.join(','),
        ...ordersData.map(row => headers.map(h => `"${(row[h] || '').replace(/"/g, '""')}"`).join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'orders_export.csv';
      link.click();
    }
  </script>
</body>
</html>
